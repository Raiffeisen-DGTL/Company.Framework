# Сборка с набором конфигураторов для настройки WebApi-приложения под Windows с использованием NTLM

### Набор конфигураторов

#### Сервера
*  HttpSysConfigurator - Конфигуратор для регистрации HttpSys в качестве сервера. Для хостинга под Windows и поддержки NTLM-аутентификации

Секция в файле конфигурации:

		"webApiConfiguration": {
			"portNumber": 9050,
			"corsOrigins": ["http://...", ...] // необязательный параметр, позволяет ограничить кроссдоменные запросы. Если не указан, то ограничений нет (*)
			...
		},

> **Внимание!** Имеется некоторая особенность: Если к сервису будет обращаться клиент из **браузера** по NTLM, то обязательно нужно прописать его (клиента) адрес хоста в параметр **additionalCorsOrigins**, а также добавить **"*"**, чтобы данный сервис мог ходить к другим сервисам. Например:

		"corsOrigins": ["http://s-msk-t-icdb999", "*"]

_________________

#### Http-клиенты

##### Конфигураторы
*  NtlmHttpClientsConfigurator - Конфигуратор для регистрации Http-клиентов со специальной настройкой для поддержки NTLM

Секция в файле конфигурации:

		"webApiEndpoints": [
			{
				"name": "<название>",
				"url": "<базовый_адрес>",
				"timeout": <таймаут_в_секундах> // необязательный параметр, 30 секунд по умолчанию
			}
		],
_________________

#### Security

##### NTLM
*  NtlmSecurityConfigurator - Регистрирует во встроенном DI схему аутентификации для NTLM, ISecurityContextFactory и WithPermissionsAttribute
*  NtlmSecurityContextFactory - Реализация ISecurityContextFactory на основе получения данных из заголовков, учетной записи Windows из запроса, либо текущей сервисной учетной записи
*  NtlmSecurityContext - Реализация ISecurityContext с учетом запроса полномочий пользователя из security-сервиса
*  WithPermissionsAttribute - Атрибут авторизации для контроллеров и действий, проверяющий полномочия пользователя

_________________

#### DefaultHttpSysRunner
Создает и запускает **HostBuilder** с конфигураторами из сборки Company.WebApi.Core.DefaultConfiguration. Применена NTLM-авторизация и сервер HttpSys. Для запуска сервиса необходимо вызвать BuildAndRun(). Если в данный метод пробросить параметр --install, то приложение запустится в режиме Windows-сервиса, однако предварительно его нужно зарегистрировать в системе
> **Внимание!** Имеется некоторая особенность: при запуске в окружении .Net Core NTLM не работает (нужно что-то дополнительно делать с заголовками Http-клиентов), в окружении .Net Framework - все отлично